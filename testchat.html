<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test API JWT + Chat</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    input, button { margin: 5px 0; padding: 5px; width: 100%; box-sizing: border-box; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-top: 10px; background: #f9f9f9; }
    .message { margin: 5px 0; }
    .me { font-weight: bold; color: blue; }
    .other { color: green; }
  </style>
</head>
<body>

<h2>Login</h2>
<input id="username" placeholder="username" value="testuser" />
<input id="password" type="password" placeholder="password" value="123456" />
<button onclick="login()">Login</button>

<h2>Chat Room</h2>
<div id="chat"></div>
<input id="chatInput" placeholder="Type your message..." />
<button onclick="sendMessage()">Send</button>

<h3>API Result</h3>
<pre id="result"></pre>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let token = null;
let socket = null;

async function login() {
  const res = await fetch('http://localhost:3000/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: username.value, password: password.value })
  });

  const data = await res.json();
  token = data.token;
  document.getElementById('result').textContent = JSON.stringify(data, null, 2);
  console.log(JSON.stringify(data, null, 2));
  // Kết nối Socket.IO sau khi login
  connectSocket();
}

// Kết nối socket
function connectSocket() {
  if (!token) return alert("Login first!");
  let groupid=2
  // Nếu muốn gửi token lên socket (auth)
  socket = io("http://localhost:4000", {
    auth: { token } 
  });
  socket.emit("join_room", groupid);

  socket.on("connect", () => {
    console.log("Socket connected:", socket.id);
    appendMessage("System", "Connected to chat");
  });

  socket.on("server_client", ({ username, message }) => {
    appendMessage(username, message, username === username.value ? 'me' : 'other');
  });

  socket.on("disconnect", () => {
    appendMessage("System", "Disconnected from chat");
  });
}

// Gửi message
function sendMessage() {
  const msgInput = document.getElementById('chatInput');
  const message = msgInput.value.trim();
  if (!message) return;

  // Gửi lên server
  socket.emit("client_server", { username: username.value,message: message, roomId:2});

  // Xóa input
  msgInput.value = "";
}

// Hiển thị message
function appendMessage(user, msg, cls='other') {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = `message ${cls}`;
  div.textContent = `${user}: ${msg}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
</script>

</body>
</html>
